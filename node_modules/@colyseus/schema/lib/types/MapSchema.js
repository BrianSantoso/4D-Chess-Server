"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MapSchema = exports.getMapProxy = void 0;
var ChangeTree_1 = require("../changes/ChangeTree");
var spec_1 = require("../spec");
var Schema_1 = require("../Schema");
function getMapProxy(value) {
    value['$proxy'] = true;
    value = new Proxy(value, {
        get: function (obj, prop) {
            if (typeof (prop) !== "symbol" && // accessing properties
                typeof (obj[prop]) === "undefined") {
                return obj.get(prop);
            }
            else {
                return obj[prop];
            }
        },
        set: function (obj, prop, setValue) {
            if (typeof (prop) !== "symbol" &&
                (prop.indexOf("$") === -1 &&
                    prop !== "onAdd" &&
                    prop !== "onRemove" &&
                    prop !== "onChange")) {
                obj.set(prop, setValue);
            }
            else {
                obj[prop] = setValue;
            }
            return true;
        },
        deleteProperty: function (obj, prop) {
            obj.delete(prop);
            return true;
        },
    });
    return value;
}
exports.getMapProxy = getMapProxy;
var MapSchema = /** @class */ (function () {
    function MapSchema(initialValues) {
        var _this = this;
        this.$changes = new ChangeTree_1.ChangeTree(this);
        this.$items = new Map();
        this.$indexes = new Map();
        this.$refId = 0;
        if (initialValues) {
            if (initialValues instanceof Map) {
                initialValues.forEach(function (v, k) { return _this.set(k, v); });
            }
            else {
                for (var k in initialValues) {
                    this.set(k, initialValues[k]);
                }
            }
        }
    }
    MapSchema.is = function (type) {
        return type['map'] !== undefined;
    };
    /** Iterator */
    MapSchema.prototype[Symbol.iterator] = function () { return this.$items[Symbol.iterator](); };
    Object.defineProperty(MapSchema.prototype, Symbol.toStringTag, {
        get: function () { return this.$items[Symbol.toStringTag]; },
        enumerable: false,
        configurable: true
    });
    MapSchema.prototype.set = function (key, value) {
        // get "index" for this value.
        var hasIndex = typeof (this.$changes.indexes[key]) !== "undefined";
        var index = (hasIndex)
            ? this.$changes.indexes[key]
            : this.$refId++;
        var operation = (hasIndex)
            ? spec_1.OPERATION.REPLACE
            : spec_1.OPERATION.ADD;
        var isRef = (value['$changes']) !== undefined;
        if (isRef) {
            value['$changes'].setParent(this, this.$changes.root, index);
        }
        //
        // (encoding)
        // set a unique id to relate directly with this key/value.
        //
        if (!hasIndex) {
            this.$changes.indexes[key] = index;
            this.$indexes.set(index, key);
        }
        else if (isRef && // if is schema, force ADD operation if value differ from previous one.
            this.$items.get(key) !== value) {
            operation = spec_1.OPERATION.ADD;
        }
        this.$items.set(key, value);
        this.$changes.change(key, operation);
        return this;
    };
    MapSchema.prototype.get = function (key) {
        return this.$items.get(key);
    };
    MapSchema.prototype.delete = function (key) {
        //
        // TODO: add a "purge" method after .encode() runs, to cleanup removed `$indexes`
        //
        // We don't remove $indexes to allow setting the same key in the same patch
        // (See "should allow to remove and set an item in the same place" test)
        //
        // // const index = this.$changes.indexes[key];
        // // this.$indexes.delete(index);
        this.$changes.delete(key);
        return this.$items.delete(key);
    };
    MapSchema.prototype.clear = function (isDecoding) {
        var _this = this;
        // discard previous operations.
        this.$changes.discard(true, true);
        this.$changes.indexes = {};
        // clear previous indexes
        this.$indexes.clear();
        // flag child items for garbage collection.
        if (isDecoding && typeof (this.$changes.getType()) !== "string") {
            this.$items.forEach(function (item) {
                _this.$changes.root.removeRef(item['$changes'].refId);
            });
        }
        // clear items
        this.$items.clear();
        this.$changes.operation({ index: 0, op: spec_1.OPERATION.CLEAR });
        // touch all structures until reach root
        this.$changes.touchParents();
    };
    MapSchema.prototype.has = function (key) {
        return this.$items.has(key);
    };
    MapSchema.prototype.forEach = function (callbackfn) {
        this.$items.forEach(callbackfn);
    };
    MapSchema.prototype.entries = function () {
        return this.$items.entries();
    };
    MapSchema.prototype.keys = function () {
        return this.$items.keys();
    };
    MapSchema.prototype.values = function () {
        return this.$items.values();
    };
    Object.defineProperty(MapSchema.prototype, "size", {
        get: function () {
            return this.$items.size;
        },
        enumerable: false,
        configurable: true
    });
    MapSchema.prototype.setIndex = function (index, key) {
        this.$indexes.set(index, key);
    };
    MapSchema.prototype.getIndex = function (index) {
        return this.$indexes.get(index);
    };
    MapSchema.prototype.getByIndex = function (index) {
        return this.$items.get(this.$indexes.get(index));
    };
    MapSchema.prototype.deleteByIndex = function (index) {
        var key = this.$indexes.get(index);
        this.$items.delete(key);
        this.$indexes.delete(index);
    };
    MapSchema.prototype.toJSON = function () {
        var map = {};
        this.forEach(function (value, key) {
            map[key] = (typeof (value['toJSON']) === "function")
                ? value['toJSON']()
                : value;
        });
        return map;
    };
    //
    // Decoding utilities
    //
    MapSchema.prototype.clone = function (isDecoding) {
        var cloned;
        if (isDecoding) {
            // client-side
            cloned = Object.assign(new MapSchema(), this);
        }
        else {
            // server-side
            cloned = new MapSchema();
            this.forEach(function (value, key) {
                if (value['$changes']) {
                    cloned.set(key, value['clone']());
                }
                else {
                    cloned.set(key, value);
                }
            });
        }
        return cloned;
    };
    MapSchema.prototype.triggerAll = function () {
        Schema_1.Schema.prototype.triggerAll.apply(this);
    };
    return MapSchema;
}());
exports.MapSchema = MapSchema;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFwU2NoZW1hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3R5cGVzL01hcFNjaGVtYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxvREFBbUQ7QUFDbkQsZ0NBQW9DO0FBQ3BDLG9DQUEyRDtBQUkzRCxTQUFnQixXQUFXLENBQUMsS0FBZ0I7SUFDeEMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQztJQUV2QixLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsS0FBSyxFQUFFO1FBQ3JCLEdBQUcsRUFBRSxVQUFDLEdBQUcsRUFBRSxJQUFJO1lBQ1gsSUFDSSxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssUUFBUSxJQUFJLHVCQUF1QjtnQkFDckQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLFdBQVcsRUFDcEM7Z0JBQ0UsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQWMsQ0FBQyxDQUFDO2FBRWxDO2lCQUFNO2dCQUNILE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3BCO1FBQ0wsQ0FBQztRQUVELEdBQUcsRUFBRSxVQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsUUFBUTtZQUNyQixJQUNJLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxRQUFRO2dCQUMxQixDQUNLLElBQWUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUNwQyxJQUFJLEtBQUssT0FBTztvQkFDaEIsSUFBSSxLQUFLLFVBQVU7b0JBQ25CLElBQUksS0FBSyxVQUFVLENBQ3RCLEVBQ0g7Z0JBQ0UsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFjLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFFckM7aUJBQU07Z0JBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQzthQUN4QjtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7UUFFRCxjQUFjLEVBQUUs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QUUsSUFBSSxDQUFDLENBQUM7U0FFakQ7YUFBTTtZQUNILGNBQWM7WUFDZCxNQUFNLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUN6QixJQUFJLENBQUMsT0FBTyxDQUFDLFVBQUMsS0FBSyxFQUFFLEdBQUc7Z0JBQ3BCLElBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFO29CQUNuQixNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUNyQztxQkFBTTtvQkFDSCxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztpQkFDMUI7WUFDTCxDQUFDLENBQUMsQ0FBQTtTQUNMO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVELDhCQUFVLEdBQVY7UUFDSSxlQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUNMLGdCQUFDO0FBQUQsQ0FBQyxBQTFNRCxJQTBNQztBQTFNWSw4QkFBUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZVRyZWUgfSBmcm9tIFwiLi4vY2hhbmdlcy9DaGFuZ2VUcmVlXCI7XG5pbXBvcnQgeyBPUEVSQVRJT04gfSBmcm9tIFwiLi4vc3BlY1wiO1xuaW1wb3J0IHsgU2NoZW1hRGVjb2RlckNhbGxiYWNrcywgU2NoZW1hIH0gZnJvbSBcIi4uL1NjaGVtYVwiO1xuXG50eXBlIEsgPSBzdHJpbmc7IC8vIFRPRE86IGFsbG93IHRvIHNwZWNpZnkgSyBnZW5lcmljIG9uIE1hcFNjaGVtYS5cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1hcFByb3h5KHZhbHVlOiBNYXBTY2hlbWEpIHtcbiAgICB2YWx1ZVsnJHByb3h5J10gPSB0cnVlO1xuXG4gICAgdmFsdWUgPSBuZXcgUHJveHkodmFsdWUsIHtcbiAgICAgICAgZ2V0OiAob2JqLCBwcm9wKSA9PiB7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgdHlwZW9mIChwcm9wKSAhPT0gXCJzeW1ib2xcIiAmJiAvLyBhY2Nlc3NpbmcgcHJvcGVydGllc1xuICAgICAgICAgICAgICAgIHR5cGVvZiAob2JqW3Byb3BdKSA9PT0gXCJ1bmRlZmluZWRcIlxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9iai5nZXQocHJvcCBhcyBzdHJpbmcpO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBvYmpbcHJvcF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG5cbiAgICAgICAgc2V0OiAob2JqLCBwcm9wLCBzZXRWYWx1ZSkgPT4ge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIHR5cGVvZiAocHJvcCkgIT09IFwic3ltYm9sXCIgJiZcbiAgICAgICAgICAgICAgICAoXG4gICAgICAgICAgICAgICAgICAgIChwcm9wIGFzIHN0cmluZykuaW5kZXhPZihcIiRcIikgPT09IC0xICYmXG4gICAgICAgICAgICAgICAgICAgIHByb3AgIT09IFwib25BZGRcIiAmJlxuICAgICAgICAgICAgICAgICAgICBwcm9wICE9PSBcIm9uUmVtb3ZlXCIgJiZcbiAgICAgICAgICAgICAgICAgICAgcHJvcCAhPT0gXCJvbkNoYW5nZVwiXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgb2JqLnNldChwcm9wIGFzIHN0cmluZywgc2V0VmFsdWUpO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG9ialtwcm9wXSA9IHNldFZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0sXG5cbiAgICAgICAgZGVsZXRlUHJvcGVydHk6IChvYmosIHByb3ApID0+IHtcbiAgICAgICAgICAgIG9iai5kZWxldGUocHJvcCBhcyBzdHJpbmcpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdmFsdWU7XG59XG5cbmV4cG9ydCBjbGFzcyBNYXBTY2hlbWE8Vj1hbnk+IGltcGxlbWVudHMgTWFwPHN0cmluZywgVj4sIFNjaGVtYURlY29kZXJDYWxsYmFja3Mge1xuICAgIHByb3RlY3RlZCAkY2hhbmdlczogQ2hhbmdlVHJlZSA9IG5ldyBDaGFuZ2VUcmVlKHRoaXMpO1xuXG4gICAgcHJvdGVjdGVkICRpdGVtczogTWFwPHN0cmluZywgVj4gPSBuZXcgTWFwPHN0cmluZywgVj4oKTtcbiAgICBwcm90ZWN0ZWQgJGluZGV4ZXM6IE1hcDxudW1iZXIsIHN0cmluZz4gPSBuZXcgTWFwPG51bWJlciwgc3RyaW5nPigpO1xuXG4gICAgcHJvdGVjdGVkICRyZWZJZDogbnVtYmVyID0gMDtcblxuICAgIC8vXG4gICAgLy8gRGVjb2RpbmcgY2FsbGJhY2tzXG4gICAgLy9cbiAgICBwdWJsaWMgb25BZGQ/OiAoaXRlbTogViwga2V5OiBzdHJpbmcpID0+IHZvaWQ7XG4gICAgcHVibGljIG9uUmVtb3ZlPzogKGl0ZW06IFYsIGtleTogc3RyaW5nKSA9PiB2b2lkO1xuICAgIHB1YmxpYyBvbkNoYW5nZT86IChpdGVtOiBWLCBrZXk6IHN0cmluZykgPT4gdm9pZDtcblxuICAgIHN0YXRpYyBpcyh0eXBlOiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIHR5cGVbJ21hcCddICE9PSB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IgKGluaXRpYWxWYWx1ZXM/OiBNYXA8c3RyaW5nLCBWPiB8IGFueSkge1xuICAgICAgICBpZiAoaW5pdGlhbFZhbHVlcykge1xuICAgICAgICAgICAgaWYgKGluaXRpYWxWYWx1ZXMgaW5zdGFuY2VvZiBNYXApIHtcbiAgICAgICAgICAgICAgICBpbml0aWFsVmFsdWVzLmZvckVhY2goKHYsIGspID0+IHRoaXMuc2V0KGssIHYpKTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGsgaW4gaW5pdGlhbFZhbHVlcykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldChrLCBpbml0aWFsVmFsdWVzW2tdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiogSXRlcmF0b3IgKi9cbiAgICBbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYWJsZUl0ZXJhdG9yPFtLLCBWXT4geyByZXR1cm4gdGhpcy4kaXRlbXNbU3ltYm9sLml0ZXJhdG9yXSgpOyB9XG4gICAgZ2V0IFtTeW1ib2wudG9TdHJpbmdUYWddKCkgeyByZXR1cm4gdGhpcy4kaXRlbXNbU3ltYm9sLnRvU3RyaW5nVGFnXSB9XG5cbiAgICBzZXQoa2V5OiBLLCB2YWx1ZTogVikge1xuICAgICAgICAvLyBnZXQgXCJpbmRleFwiIGZvciB0aGlzIHZhbHVlLlxuICAgICAgICBjb25zdCBoYXNJbmRleCA9IHR5cGVvZih0aGlzLiRjaGFuZ2VzLmluZGV4ZXNba2V5XSkgIT09IFwidW5kZWZpbmVkXCI7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gKGhhc0luZGV4KVxuICAgICAgICAgICAgPyB0aGlzLiRjaGFuZ2VzLmluZGV4ZXNba2V5XVxuICAgICAgICAgICAgOiB0aGlzLiRyZWZJZCsrO1xuXG4gICAgICAgIGxldCBvcGVyYXRpb246IE9QRVJBVElPTiA9IChoYXNJbmRleClcbiAgICAgICAgICAgID8gT1BFUkFUSU9OLlJFUExBQ0VcbiAgICAgICAgICAgIDogT1BFUkFUSU9OLkFERDtcblxuICAgICAgICBjb25zdCBpc1JlZiA9ICh2YWx1ZVsnJGNoYW5nZXMnXSkgIT09IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKGlzUmVmKSB7XG4gICAgICAgICAgICAodmFsdWVbJyRjaGFuZ2VzJ10gYXMgQ2hhbmdlVHJlZSkuc2V0UGFyZW50KFxuICAgICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgICAgdGhpcy4kY2hhbmdlcy5yb290LFxuICAgICAgICAgICAgICAgIGluZGV4XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgLy8gKGVuY29kaW5nKVxuICAgICAgICAvLyBzZXQgYSB1bmlxdWUgaWQgdG8gcmVsYXRlIGRpcmVjdGx5IHdpdGggdGhpcyBrZXkvdmFsdWUuXG4gICAgICAgIC8vXG4gICAgICAgIGlmICghaGFzSW5kZXgpIHtcbiAgICAgICAgICAgIHRoaXMuJGNoYW5nZXMuaW5kZXhlc1trZXldID0gaW5kZXg7XG4gICAgICAgICAgICB0aGlzLiRpbmRleGVzLnNldChpbmRleCwga2V5KTtcblxuICAgICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAgICAgaXNSZWYgJiYgLy8gaWYgaXMgc2NoZW1hLCBmb3JjZSBBREQgb3BlcmF0aW9uIGlmIHZhbHVlIGRpZmZlciBmcm9tIHByZXZpb3VzIG9uZS5cbiAgICAgICAgICAgIHRoaXMuJGl0ZW1zLmdldChrZXkpICE9PSB2YWx1ZVxuICAgICAgICApIHtcbiAgICAgICAgICAgIG9wZXJhdGlvbiA9IE9QRVJBVElPTi5BREQ7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLiRpdGVtcy5zZXQoa2V5LCB2YWx1ZSk7XG5cbiAgICAgICAgdGhpcy4kY2hhbmdlcy5jaGFuZ2Uoa2V5LCBvcGVyYXRpb24pO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGdldChrZXk6IEspIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGl0ZW1zLmdldChrZXkpO1xuICAgIH1cblxuICAgIGRlbGV0ZShrZXk6IEspIHtcbiAgICAgICAgLy9cbiAgICAgICAgLy8gVE9ETzogYWRkIGEgXCJwdXJnZVwiIG1ldGhvZCBhZnRlciAuZW5jb2RlKCkgcnVucywgdG8gY2xlYW51cCByZW1vdmVkIGAkaW5kZXhlc2BcbiAgICAgICAgLy9cbiAgICAgICAgLy8gV2UgZG9uJ3QgcmVtb3ZlICRpbmRleGVzIHRvIGFsbG93IHNldHRpbmcgdGhlIHNhbWUga2V5IGluIHRoZSBzYW1lIHBhdGNoXG4gICAgICAgIC8vIChTZWUgXCJzaG91bGQgYWxsb3cgdG8gcmVtb3ZlIGFuZCBzZXQgYW4gaXRlbSBpbiB0aGUgc2FtZSBwbGFjZVwiIHRlc3QpXG4gICAgICAgIC8vXG4gICAgICAgIC8vIC8vIGNvbnN0IGluZGV4ID0gdGhpcy4kY2hhbmdlcy5pbmRleGVzW2tleV07XG4gICAgICAgIC8vIC8vIHRoaXMuJGluZGV4ZXMuZGVsZXRlKGluZGV4KTtcblxuICAgICAgICB0aGlzLiRjaGFuZ2VzLmRlbGV0ZShrZXkpO1xuICAgICAgICByZXR1cm4gdGhpcy4kaXRlbXMuZGVsZXRlKGtleSk7XG4gICAgfVxuXG4gICAgY2xlYXIoaXNEZWNvZGluZz86IGJvb2xlYW4pIHtcbiAgICAgICAgLy8gZGlzY2FyZCBwcmV2aW91cyBvcGVyYXRpb25zLlxuICAgICAgICB0aGlzLiRjaGFuZ2VzLmRpc2NhcmQodHJ1ZSwgdHJ1ZSk7XG4gICAgICAgIHRoaXMuJGNoYW5nZXMuaW5kZXhlcyA9IHt9O1xuXG4gICAgICAgIC8vIGNsZWFyIHByZXZpb3VzIGluZGV4ZXNcbiAgICAgICAgdGhpcy4kaW5kZXhlcy5jbGVhcigpO1xuXG4gICAgICAgIC8vIGZsYWcgY2hpbGQgaXRlbXMgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi5cbiAgICAgICAgaWYgKGlzRGVjb2RpbmcgJiYgdHlwZW9mICh0aGlzLiRjaGFuZ2VzLmdldFR5cGUoKSkgIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIHRoaXMuJGl0ZW1zLmZvckVhY2goKGl0ZW06IFYpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLiRjaGFuZ2VzLnJvb3QucmVtb3ZlUmVmKGl0ZW1bJyRjaGFuZ2VzJ10ucmVmSWQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBjbGVhciBpdGVtc1xuICAgICAgICB0aGlzLiRpdGVtcy5jbGVhcigpO1xuXG4gICAgICAgIHRoaXMuJGNoYW5nZXMub3BlcmF0aW9uKHsgaW5kZXg6IDAsIG9wOiBPUEVSQVRJT04uQ0xFQVIgfSk7XG5cbiAgICAgICAgLy8gdG91Y2ggYWxsIHN0cnVjdHVyZXMgdW50aWwgcmVhY2ggcm9vdFxuICAgICAgICB0aGlzLiRjaGFuZ2VzLnRvdWNoUGFyZW50cygpO1xuICAgIH1cblxuICAgIGhhcyAoa2V5OiBLKSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRpdGVtcy5oYXMoa2V5KTtcbiAgICB9XG5cbiAgICBmb3JFYWNoKGNhbGxiYWNrZm46ICh2YWx1ZTogViwga2V5OiBLLCBtYXA6IE1hcDxLLCBWPikgPT4gdm9pZCkge1xuICAgICAgICB0aGlzLiRpdGVtcy5mb3JFYWNoKGNhbGxiYWNrZm4pO1xuICAgIH1cblxuICAgIGVudHJpZXMgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy4kaXRlbXMuZW50cmllcygpO1xuICAgIH1cblxuICAgIGtleXMgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy4kaXRlbXMua2V5cygpO1xuICAgIH1cblxuICAgIHZhbHVlcygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGl0ZW1zLnZhbHVlcygpO1xuICAgIH1cblxuICAgIGdldCBzaXplICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGl0ZW1zLnNpemU7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHNldEluZGV4KGluZGV4OiBudW1iZXIsIGtleTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuJGluZGV4ZXMuc2V0KGluZGV4LCBrZXkpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRJbmRleChpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRpbmRleGVzLmdldChpbmRleCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldEJ5SW5kZXgoaW5kZXg6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gdGhpcy4kaXRlbXMuZ2V0KHRoaXMuJGluZGV4ZXMuZ2V0KGluZGV4KSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGRlbGV0ZUJ5SW5kZXgoaW5kZXg6IG51bWJlcikge1xuICAgICAgICBjb25zdCBrZXkgPSB0aGlzLiRpbmRleGVzLmdldChpbmRleCk7XG4gICAgICAgIHRoaXMuJGl0ZW1zLmRlbGV0ZShrZXkpO1xuICAgICAgICB0aGlzLiRpbmRleGVzLmRlbGV0ZShpbmRleCk7XG4gICAgfVxuXG4gICAgdG9KU09OKCkge1xuICAgICAgICBjb25zdCBtYXA6IGFueSA9IHt9O1xuXG4gICAgICAgIHRoaXMuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xuICAgICAgICAgICAgbWFwW2tleV0gPSAodHlwZW9mICh2YWx1ZVsndG9KU09OJ10pID09PSBcImZ1bmN0aW9uXCIpXG4gICAgICAgICAgICAgICAgPyB2YWx1ZVsndG9KU09OJ10oKVxuICAgICAgICAgICAgICAgIDogdmFsdWU7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBtYXA7XG4gICAgfVxuXG4gICAgLy9cbiAgICAvLyBEZWNvZGluZyB1dGlsaXRpZXNcbiAgICAvL1xuICAgIGNsb25lKGlzRGVjb2Rpbmc/OiBib29sZWFuKTogTWFwU2NoZW1hPFY+IHtcbiAgICAgICAgbGV0IGNsb25lZDogTWFwU2NoZW1hO1xuXG4gICAgICAgIGlmIChpc0RlY29kaW5nKSB7XG4gICAgICAgICAgICAvLyBjbGllbnQtc2lkZVxuICAgICAgICAgICAgY2xvbmVkID0gT2JqZWN0LmFzc2lnbihuZXcgTWFwU2NoZW1hKCksIHRoaXMpO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBzZXJ2ZXItc2lkZVxuICAgICAgICAgICAgY2xvbmVkID0gbmV3IE1hcFNjaGVtYSgpO1xuICAgICAgICAgICAgdGhpcy5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlWyckY2hhbmdlcyddKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsb25lZC5zZXQoa2V5LCB2YWx1ZVsnY2xvbmUnXSgpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjbG9uZWQuc2V0KGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY2xvbmVkO1xuICAgIH1cblxuICAgIHRyaWdnZXJBbGwgKCk6IHZvaWQge1xuICAgICAgICBTY2hlbWEucHJvdG90eXBlLnRyaWdnZXJBbGwuYXBwbHkodGhpcyk7XG4gICAgfVxufSJdfQ==