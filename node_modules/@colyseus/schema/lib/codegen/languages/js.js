"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generate = void 0;
var types_1 = require("../types");
var typeMaps = {
    "string": "string",
    "number": "number",
    "boolean": "boolean",
    "int8": "number",
    "uint8": "number",
    "int16": "number",
    "uint16": "number",
    "int32": "number",
    "uint32": "number",
    "int64": "number",
    "uint64": "number",
    "float32": "number",
    "float64": "number",
};
var distinct = function (value, index, self) { return self.indexOf(value) === index; };
function generate(context, options) {
    return context.classes.map(function (klass) { return ({
        name: klass.name + ".js",
        content: generateClass(klass, options.namespace, context.classes)
    }); });
}
exports.generate = generate;
function generateClass(klass, namespace, allClasses) {
    var allRefs = [];
    klass.properties.forEach(function (property) {
        var type = property.type;
        // keep all refs list
        if ((type === "ref" || type === "array" || type === "map")) {
            allRefs.push(property);
        }
    });
    return types_1.getCommentHeader() + "\n\nconst schema = require(\"@colyseus/schema\");\nconst Schema = schema.Schema;\nconst type = schema.type;\n" + allRefs.
        filter(function (ref) { return ref.childType && typeMaps[ref.childType] === undefined; }).
        map(function (ref) { return ref.childType; }).
        concat(types_1.getInheritanceTree(klass, allClasses, false).map(function (klass) { return klass.name; })).
        filter(distinct).
        map(function (childType) { return "const " + childType + " = require(\"./" + childType + "\");"; }).
        join("\n") + "\n\nclass " + klass.name + " extends " + klass.extends + " {\n    constructor () {\n        super();\n" + klass.properties.
        filter(function (prop) { return prop.childType !== undefined; }).
        map(function (prop) { return "        " + generatePropertyInitializer(prop); }).join("\n") + "\n    }\n}\n" + klass.properties.map(function (prop) { return generatePropertyDeclaration(klass.name, prop); }).join("\n") + "\n\nexport default " + klass.name + ";\n";
}
function generatePropertyDeclaration(className, prop) {
    var typeArgs;
    if (prop.childType) {
        var isUpcaseFirst = prop.childType.match(/^[A-Z]/);
        if (isUpcaseFirst) {
            typeArgs += ", " + prop.childType;
        }
        else {
            typeArgs += ", \"" + prop.childType + "\"";
        }
        if (prop.type === "ref") {
            typeArgs = "" + prop.childType;
        }
        else if (prop.type === "array") {
            typeArgs = (isUpcaseFirst)
                ? "[ " + prop.childType + " ]"
                : "[ \"" + prop.childType + "\" ]";
        }
        else if (prop.type === "map") {
            typeArgs = (isUpcaseFirst)
                ? "{ map: " + prop.childType + " }"
                : "{ map: \"" + prop.childType + "\" }";
        }
    }
    else {
        typeArgs = "\"" + prop.type + "\"";
    }
    return "type(" + typeArgs + ")(" + className + ".prototype, \"" + prop.name + "\");";
}
function generatePropertyInitializer(prop) {
    var initializer = "";
    if (prop.type === "ref") {
        initializer = "new " + prop.childType + "()";
    }
    else if (prop.type === "array") {
        initializer = "new schema.ArraySchema()";
    }
    else if (prop.type === "map") {
        initializer = "new schema.MapSchema()";
    }
    return "this." + prop.name + " = " + initializer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29kZWdlbi9sYW5ndWFnZXMvanMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsa0NBQWdHO0FBR2hHLElBQU0sUUFBUSxHQUFHO0lBQ2IsUUFBUSxFQUFFLFFBQVE7SUFDbEIsUUFBUSxFQUFFLFFBQVE7SUFDbEIsU0FBUyxFQUFFLFNBQVM7SUFDcEIsTUFBTSxFQUFFLFFBQVE7SUFDaEIsT0FBTyxFQUFFLFFBQVE7SUFDakIsT0FBTyxFQUFFLFFBQVE7SUFDakIsUUFBUSxFQUFFLFFBQVE7SUFDbEIsT0FBTyxFQUFFLFFBQVE7SUFDakIsUUFBUSxFQUFFLFFBQVE7SUFDbEIsT0FBTyxFQUFFLFFBQVE7SUFDakIsUUFBUSxFQUFFLFFBQVE7SUFDbEIsU0FBUyxFQUFFLFFBQVE7SUFDbkIsU0FBUyxFQUFFLFFBQVE7Q0FDdEIsQ0FBQTtBQUVELElBQU0sUUFBUSxHQUFHLFVBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLElBQUssT0FBQSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLEtBQUssRUFBN0IsQ0FBNkIsQ0FBQztBQUV2RSxTQUFnQixRQUFRLENBQUUsT0FBZ0IsRUFBRSxPQUF3QjtJQUNoRSxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQUEsS0FBSyxJQUFJLE9BQUEsQ0FBQztRQUNqQyxJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksR0FBRyxLQUFLO1FBQ3hCLE9BQU8sRUFBRSxhQUFhLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQztLQUNwRSxDQUFDLEVBSGtDLENBR2xDLENBQUMsQ0FBQztBQUNSLENBQUM7QUFMRCw0QkFLQztBQUVELFNBQVMsYUFBYSxDQUFDLEtBQVksRUFBRSxTQUFpQixFQUFFLFVBQW1CO0lBQ3ZFLElBQU0sT0FBTyxHQUFlLEVB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QUFTLE9BQUk7Z0JBQzlCLENBQUMsQ0FBQyxjQUFXLElBQUksQ0FBQyxTQUFTLFNBQUssQ0FBQztTQUN4QztLQUVKO1NBQU07UUFDSCxRQUFRLEdBQUcsT0FBSSxJQUFJLENBQUMsSUFBSSxPQUFHLENBQUM7S0FDL0I7SUFFRCxPQUFPLFVBQVEsUUFBUSxVQUFLLFNBQVMsc0JBQWdCLElBQUksQ0FBQyxJQUFJLFNBQUssQ0FBQztBQUN4RSxDQUFDO0FBRUQsU0FBUywyQkFBMkIsQ0FBQyxJQUFjO0lBQy9DLElBQUksV0FBVyxHQUFHLEVBQUUsQ0FBQztJQUVyQixJQUFHLElBQUksQ0FBQyxJQUFJLEtBQUssS0FBSyxFQUFFO1FBQ3BCLFdBQVcsR0FBRyxTQUFPLElBQUksQ0FBQyxTQUFTLE9BQUksQ0FBQztLQUUzQztTQUFNLElBQUcsSUFBSSxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUU7UUFDN0IsV0FBVyxHQUFHLDBCQUEwQixDQUFDO0tBRTVDO1NBQU0sSUFBRyxJQUFJLENBQUMsSUFBSSxLQUFLLEtBQUssRUFBRTtRQUMzQixXQUFXLEdBQUcsd0JBQXdCLENBQUM7S0FDMUM7SUFFRCxPQUFPLFVBQVEsSUFBSSxDQUFDLElBQUksV0FBTSxXQUFhLENBQUM7QUFDaEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENsYXNzLCBQcm9wZXJ0eSwgRmlsZSwgZ2V0Q29tbWVudEhlYWRlciwgZ2V0SW5oZXJpdGFuY2VUcmVlLCBDb250ZXh0IH0gZnJvbSBcIi4uL3R5cGVzXCI7XG5pbXBvcnQgeyBHZW5lcmF0ZU9wdGlvbnMgfSBmcm9tIFwiLi4vYXBpXCI7XG5cbmNvbnN0IHR5cGVNYXBzID0ge1xuICAgIFwic3RyaW5nXCI6IFwic3RyaW5nXCIsXG4gICAgXCJudW1iZXJcIjogXCJudW1iZXJcIixcbiAgICBcImJvb2xlYW5cIjogXCJib29sZWFuXCIsXG4gICAgXCJpbnQ4XCI6IFwibnVtYmVyXCIsXG4gICAgXCJ1aW50OFwiOiBcIm51bWJlclwiLFxuICAgIFwiaW50MTZcIjogXCJudW1iZXJcIixcbiAgICBcInVpbnQxNlwiOiBcIm51bWJlclwiLFxuICAgIFwiaW50MzJcIjogXCJudW1iZXJcIixcbiAgICBcInVpbnQzMlwiOiBcIm51bWJlclwiLFxuICAgIFwiaW50NjRcIjogXCJudW1iZXJcIixcbiAgICBcInVpbnQ2NFwiOiBcIm51bWJlclwiLFxuICAgIFwiZmxvYXQzMlwiOiBcIm51bWJlclwiLFxuICAgIFwiZmxvYXQ2NFwiOiBcIm51bWJlclwiLFxufVxuXG5jb25zdCBkaXN0aW5jdCA9ICh2YWx1ZSwgaW5kZXgsIHNlbGYpID0+IHNlbGYuaW5kZXhPZih2YWx1ZSkgPT09IGluZGV4O1xuXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGUgKGNvbnRleHQ6IENvbnRleHQsIG9wdGlvbnM6IEdlbmVyYXRlT3B0aW9ucyk6IEZpbGVbXSB7XG4gICAgcmV0dXJuIGNvbnRleHQuY2xhc3Nlcy5tYXAoa2xhc3MgPT4gKHtcbiAgICAgICAgbmFtZToga2xhc3MubmFtZSArIFwiLmpzXCIsXG4gICAgICAgIGNvbnRlbnQ6IGdlbmVyYXRlQ2xhc3Moa2xhc3MsIG9wdGlvbnMubmFtZXNwYWNlLCBjb250ZXh0LmNsYXNzZXMpXG4gICAgfSkpO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUNsYXNzKGtsYXNzOiBDbGFzcywgbmFtZXNwYWNlOiBzdHJpbmcsIGFsbENsYXNzZXM6IENsYXNzW10pIHtcbiAgICBjb25zdCBhbGxSZWZzOiBQcm9wZXJ0eVtdID0gW107XG4gICAga2xhc3MucHJvcGVydGllcy5mb3JFYWNoKHByb3BlcnR5ID0+IHtcbiAgICAgICAgbGV0IHR5cGUgPSBwcm9wZXJ0eS50eXBlO1xuXG4gICAgICAgIC8vIGtlZXAgYWxsIHJlZnMgbGlzdFxuICAgICAgICBpZiAoKHR5cGUgPT09IFwicmVmXCIgfHwgdHlwZSA9PT0gXCJhcnJheVwiIHx8IHR5cGUgPT09IFwibWFwXCIpKSB7XG4gICAgICAgICAgICBhbGxSZWZzLnB1c2gocHJvcGVydHkpO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYCR7Z2V0Q29tbWVudEhlYWRlcigpfVxuXG5jb25zdCBzY2hlbWEgPSByZXF1aXJlKFwiQGNvbHlzZXVzL3NjaGVtYVwiKTtcbmNvbnN0IFNjaGVtYSA9IHNjaGVtYS5TY2hlbWE7XG5jb25zdCB0eXBlID0gc2NoZW1hLnR5cGU7XG4ke2FsbFJlZnMuXG4gICAgZmlsdGVyKHJlZiA9PiByZWYuY2hpbGRUeXBlICYmIHR5cGVNYXBzW3JlZi5jaGlsZFR5cGVdID09PSB1bmRlZmluZWQpLlxuICAgIG1hcChyZWYgPT4gcmVmLmNoaWxkVHlwZSkuXG4gICAgY29uY2F0KGdldEluaGVyaXRhbmNlVHJlZShrbGFzcywgYWxsQ2xhc3NlcywgZmFsc2UpLm1hcChrbGFzcyA9PiBrbGFzcy5uYW1lKSkuXG4gICAgZmlsdGVyKGRpc3RpbmN0KS5cbiAgICBtYXAoY2hpbGRUeXBlID0+IGBjb25zdCAke2NoaWxkVHlwZX0gPSByZXF1aXJlKFwiLi8ke2NoaWxkVHlwZX1cIik7YCkuXG4gICAgam9pbihcIlxcblwiKX1cblxuY2xhc3MgJHtrbGFzcy5uYW1lfSBleHRlbmRzICR7a2xhc3MuZXh0ZW5kc30ge1xuICAgIGNvbnN0cnVjdG9yICgpIHtcbiAgICAgICAgc3VwZXIoKTtcbiR7a2xhc3MucHJvcGVydGllcy5cbiAgICBmaWx0ZXIocHJvcCA9PiBwcm9wLmNoaWxkVHlwZSAhPT0gdW5kZWZpbmVkKS5cbiAgICBtYXAocHJvcCA9PiBcIiAgICAgICAgXCIgKyBnZW5lcmF0ZVByb3BlcnR5SW5pdGlhbGl6ZXIocHJvcCkpLmpvaW4oXCJcXG5cIil9XG4gICAgfVxufVxuJHtrbGFzcy5wcm9wZXJ0aWVzLm1hcChwcm9wID0+IGdlbmVyYXRlUHJvcGVydHlEZWNsYXJhdGlvbihrbGFzcy5uYW1lLCBwcm9wKSkuam9pbihcIlxcblwiKX1cblxuZXhwb3J0IGRlZmF1bHQgJHtrbGFzcy5uYW1lfTtcbmA7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlUHJvcGVydHlEZWNsYXJhdGlvbihjbGFzc05hbWU6IHN0cmluZywgcHJvcDogUHJvcGVydHkpIHtcbiAgICBsZXQgdHlwZUFyZ3M6IHN0cmluZztcblxuICAgIGlmIChwcm9wLmNoaWxkVHlwZSkge1xuICAgICAgICBjb25zdCBpc1VwY2FzZUZpcnN0ID0gcHJvcC5jaGlsZFR5cGUubWF0Y2goL15bQS1aXS8pO1xuXG4gICAgICAgIGlmIChpc1VwY2FzZUZpcnN0KSB7XG4gICAgICAgICAgICB0eXBlQXJncyArPSBgLCAke3Byb3AuY2hpbGRUeXBlfWA7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHR5cGVBcmdzICs9IGAsIFwiJHtwcm9wLmNoaWxkVHlwZX1cImA7XG4gICAgICAgIH1cblxuICAgICAgICBpZihwcm9wLnR5cGUgPT09IFwicmVmXCIpIHtcbiAgICAgICAgICAgIHR5cGVBcmdzID0gYCR7cHJvcC5jaGlsZFR5cGV9YDtcblxuICAgICAgICB9IGVsc2UgaWYocHJvcC50eXBlID09PSBcImFycmF5XCIpIHtcbiAgICAgICAgICAgIHR5cGVBcmdzID0gKGlzVXBjYXNlRmlyc3QpXG4gICAgICAgICAgICAgICAgPyBgWyAke3Byb3AuY2hpbGRUeXBlfSBdYFxuICAgICAgICAgICAgICAgIDogYFsgXCIke3Byb3AuY2hpbGRUeXBlfVwiIF1gO1xuXG4gICAgICAgIH0gZWxzZSBpZihwcm9wLnR5cGUgPT09IFwibWFwXCIpIHtcbiAgICAgICAgICAgIHR5cGVBcmdzID0gKGlzVXBjYXNlRmlyc3QpXG4gICAgICAgICAgICAgICAgPyBgeyBtYXA6ICR7cHJvcC5jaGlsZFR5cGV9IH1gXG4gICAgICAgICAgICAgICAgOiBgeyBtYXA6IFwiJHtwcm9wLmNoaWxkVHlwZX1cIiB9YDtcbiAgICAgICAgfVxuXG4gICAgfSBlbHNlIHtcbiAgICAgICAgdHlwZUFyZ3MgPSBgXCIke3Byb3AudHlwZX1cImA7XG4gICAgfVxuXG4gICAgcmV0dXJuIGB0eXBlKCR7dHlwZUFyZ3N9KSgke2NsYXNzTmFtZX0ucHJvdG90eXBlLCBcIiR7cHJvcC5uYW1lfVwiKTtgO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZVByb3BlcnR5SW5pdGlhbGl6ZXIocHJvcDogUHJvcGVydHkpIHtcbiAgICBsZXQgaW5pdGlhbGl6ZXIgPSBcIlwiO1xuXG4gICAgaWYocHJvcC50eXBlID09PSBcInJlZlwiKSB7XG4gICAgICAgIGluaXRpYWxpemVyID0gYG5ldyAke3Byb3AuY2hpbGRUeXBlfSgpYDtcblxuICAgIH0gZWxzZSBpZihwcm9wLnR5cGUgPT09IFwiYXJyYXlcIikge1xuICAgICAgICBpbml0aWFsaXplciA9IGBuZXcgc2NoZW1hLkFycmF5U2NoZW1hKClgO1xuXG4gICAgfSBlbHNlIGlmKHByb3AudHlwZSA9PT0gXCJtYXBcIikge1xuICAgICAgICBpbml0aWFsaXplciA9IGBuZXcgc2NoZW1hLk1hcFNjaGVtYSgpYDtcbiAgICB9XG5cbiAgICByZXR1cm4gYHRoaXMuJHtwcm9wLm5hbWV9ID0gJHtpbml0aWFsaXplcn1gO1xufVxuIl19