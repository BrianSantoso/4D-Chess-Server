"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generate = void 0;
var types_1 = require("../types");
var typeMaps = {
    "string": "string",
    "number": "varint_t",
    "boolean": "bool",
    "int8": "int8_t",
    "uint8": "uint8_t",
    "int16": "int16_t",
    "uint16": "uint16_t",
    "int32": "int32_t",
    "uint32": "uint32_t",
    "int64": "int64_t",
    "uint64": "uint64_t",
    "float32": "float32_t",
    "float64": "float64_t",
};
var typeInitializer = {
    "string": '""',
    "number": "0",
    "boolean": "false",
    "int8": "0",
    "uint8": "0",
    "int16": "0",
    "uint16": "0",
    "int32": "0",
    "uint32": "0",
    "int64": "0",
    "uint64": "0",
    "float32": "0",
    "float64": "0",
};
/**
 * C++ Code Generator
 */
var capitalize = function (s) {
    if (typeof s !== 'string')
        return '';
    return s.charAt(0).toUpperCase() + s.slice(1);
};
var distinct = function (value, index, self) { return self.indexOf(value) === index; };
function generate(context, options) {
    return context.classes.map(function (klass) { return ({
        name: klass.name + ".hpp",
        content: generateClass(klass, options.namespace, context.classes)
    }); });
}
exports.generate = generate;
function generateClass(klass, namespace, allClasses) {
    var propertiesPerType = {};
    var allRefs = [];
    klass.properties.forEach(function (property) {
        var type = property.type;
        if (!propertiesPerType[type]) {
            propertiesPerType[type] = [];
        }
        propertiesPerType[type].push(property);
        // keep all refs list
        if ((type === "ref" || type === "array" || type === "map")) {
            allRefs.push(property);
        }
    });
    var allProperties = getAllProperties(klass, allClasses);
    var createInstanceMethod = (allRefs.length === 0) ? "" :
        "\tinline Schema* createInstance(std::type_index type) {\n\t\t" + generateFieldIfElseChain(allRefs, function (property) { return "type == typeid(" + property.childType + ")"; }, function (property) { return "return new " + property.childType + "();"; }, function (property) { return typeMaps[property.childType] === undefined; }) + "\n\t\treturn " + klass.extends + "::createInstance(type);\n\t}";
    return types_1.getCommentHeader() + "\n#ifndef __SCHEMA_CODEGEN_" + klass.name.toUpperCase() + "_H__\n#define __SCHEMA_CODEGEN_" + klass.name.toUpperCase() + "_H__ 1\n\n#include \"schema.h\"\n#include <typeinfo>\n#include <typeindex>\n\n" + allRefs.
        filter(function (ref) { return ref.childType && typeMaps[ref.childType] === undefined; }).
        map(function (ref) { return ref.childType; }).
        concat(types_1.getInheritanceTree(klass, allClasses, false).map(function (klass) { return klass.name; })).
        filter(distinct).
        map(function (childType) { return "#include \"" + childType + ".hpp\""; }).
        join("\n") + "\n\nusing namespace colyseus::schema;\n\n" + (namespace ? "namespace " + namespace + " {" : "") + "\nclass " + klass.name + " : public " + klass.extends + " {\npublic:\n" + klass.properties.map(function (prop) { return generateProperty(prop); }).join("\n") + "\n\n\t" + klass.name + "() {\n\t\tthis->_indexes = " + generateAllIndexes(allProperties) + ";\n\t\tthis->_types = " + generateAllTypes(allProperties) + ";\n\t\tthis->_childPrimitiveTypes = " + generateAllChildPrimitiveTypes(allProperties) + ";\n\t\tthis->_childSchemaTypes = " + generateAllChildSchemaTypes(allProperties) + ";\n\t}\n\n\tvirtual ~" + klass.name + "() {\n\t\t" + generateDestructors(allProperties).join("\n\t\t") + "\n\t}\n\nprotected:\n" + Object.keys(propertiesPerType).map(function (type) {
        return generateGettersAndSetters(klass, type, propertiesPerType[type]);
    }).
        join("\n") + "\n\n" + createInstanceMethod + "\n};\n" + (namespace ? "}" : "") + "\n\n#endif\n";
}
function generateProperty(prop) {
    var property = "";
    var langType;
    var initializer = "";
    var isPropPointer = "";
    if (prop.childType) {
        var isUpcaseFirst = prop.childType.match(/^[A-Z]/);
        if (prop.type === "ref") {
            langType = "" + prop.childType;
            initializer = "new " + prop.childType + "()";
        }
        else if (prop.type === "array") {
            langType = (isUpcaseFirst)
                ? "ArraySchema<" + prop.childType + "*>"
                : "ArraySchema<" + typeMaps[prop.childType] + ">";
            initializer = "new " + langType + "()";
        }
        else if (prop.type === "map") {
            langType = (isUpcaseFirst)
                ? "MapSchema<" + prop.childType + "*>"
                : "MapSchema<" + typeMaps[prop.childType] + ">";
            initializer = "new " + langType + "()";
        }
        isPropPointer = "*";
    }
    else {
        langType = typeMaps[prop.type];
        initializer = typeInitializer[prop.type];
    }
    property += " " + langType + " " + isPropPointer + prop.name;
    return "\t" + property + " = " + initializer + ";";
}
function generateGettersAndSetters(klass, type, properties) {
    var langType = typeMaps[type];
    var typeCast = "";
    var getMethodName = "get" + capitalize(type);
    var setMethodName = "set" + capitalize(type);
    if (type === "ref") {
        langType = "Schema*";
    }
    else if (type === "array") {
        langType = "ArraySchema<char*> *";
        typeCast = "(ArraySchema<char*> *)";
    }
    else if (type === "map") {
        langType = "MapSchema<char*> *";
        typeCast = "(MapSchema<char*> *)";
    }
    return "\tinline " + langType + " " + getMethodName + "(const string &field)\n\t{\n\t\t" + generateFieldIfElseChain(properties, function (property) { return "field == \"" + property.name + "\""; }, function (property) { return "return " + typeCast + "this->" + property.name + ";"; }) + "\n\t\treturn " + klass.extends + "::" + getMethodName + "(field);\n\t}\n\n\tinline void " + setMethodName + "(const string &field, " + langType + " value)\n\t{\n\t\t" + generateFieldIfElseChain(properties, function (property) { return "field == \"" + property.name + "\""; }, function (property) {
        var isSchemaType = (typeMaps[property.childType] === undefined);
        if (type === "ref") {
            langType = property.childType + "*";
            typeCast = (isSchemaType)
                ? "(" + property.childType + "*)"
                : "/* bug? */";
        }
        else if (type === "array") {
            typeCast = (isSchemaType)
                ? "(ArraySchema<" + property.childType + "*> *)"
                : "(ArraySchema<" + typeMaps[property.childType] + "> *)";
        }
        else if (type === "map") {
            typeCast = (isSchemaType)
                ? "(MapSchema<" + property.childType + "*> *)"
                : "(MapSchema<" + typeMaps[property.childType] + "> *)";
        }
        return "this->" + property.name + " = " + typeCast + "value;\n\t\t\treturn;";
    }) + "\n\t\treturn " + klass.extends + "::" + setMethodName + "(field, value);\n\t}";
}
function generateFieldIfElseChain(properties, ifCallback, callback, filter) {
    if (filter === void 0) { filter = function (_) { return true; }; }
    var chain = "";
    var uniqueChecks = [];
    properties.filter(filter).forEach(function (property, i) {
        var check = ifCallback(property);
        if (uniqueChecks.indexOf(check) === -1) {
            uniqueChecks.push(check);
        }
        else {
            return;
        }
        if (i === 0) {
            chain += "if ";
        }
        else {
            chain += " else if ";
        }
        chain += "(" + check + ")\n\t\t{\n\t\t\t" + callback(property) + "\n\n\t\t}";
    });
    return chain;
}
function generateAllIndexes(properties) {
    return "{" + properties.map(function (property, i) { return "{" + i + ", \"" + property.name + "\"}"; }).join(", ") + "}";
}
function generateAllTypes(properties) {
    return "{" + properties.map(function (property, i) { return "{" + i + ", \"" + property.type + "\"}"; }).join(", ") + "}";
}
function generateAllChildSchemaTypes(properties) {
    return "{" + properties.map(function (property, i) {
        if (property.childType && typeMaps[property.childType] === undefined) {
            return "{" + i + ", typeid(" + property.childType + ")}";
        }
        else {
            return null;
        }
    }).filter(function (r) { return r !== null; }).join(", ") + "}";
}
function generateAllChildPrimitiveTypes(properties) {
    return "{" + properties.map(function (property, i) {
        if (typeMaps[property.childType] !== undefined) {
            return "{" + i + ", \"" + property.childType + "\"}";
        }
        else {
            return null;
        }
    }).filter(function (r) { return r !== null; }).join(", ") + "}";
}
function generateDestructors(properties) {
    return properties.map(function (property, i) {
        if (property.childType) {
            return "delete this->" + property.name + ";";
        }
        else {
            return null;
        }
    }).filter(function (r) { return r !== null; });
}
function getAllProperties(klass, allClasses) {
    var properties = [];
    types_1.getInheritanceTree(klass, allClasses).reverse().forEach(function (klass) {
        properties = properties.concat(klass.properties);
    });
    return properties;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3BwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvZGVnZW4vbGFuZ3VhZ2VzL2NwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxrQ0FBZ0c7QUFHaEcsSUFBTSxRQUFRLEdBQUc7SUFDYixRQUFRLEVBQUUsUUFBUTtJQUNsQixRQUFRLEVBQUUsVUFBVTtJQUNwQixTQUFTLEVBQUUsTUFBTTtJQUNqQixNQUFNLEVBQUUsUUFBUTtJQUNoQixPQUFPLEVBQUUsU0FBUztJQUNsQixPQUFPLEVBQUUsU0FBUztJQUNsQixRQUFRLEVBQUUsVUFBVTtJQUNwQixPQUFPLEVBQUUsU0FBUztJQUNsQixRQUFRLEVBQUUsVUFBVTtJQUNwQixPQUFPLEVBQUUsU0FBUztJQUNsQixRQUFRLEVBQUUsVUFBVTtJQUNwQixTQUFTLEVBQUUsV0FBVztJQUN0QixTQUFTLEVBQUUsV0FBVztDQUN6QixDQUFBO0FBRUQsSUFBTSxlQUFlLEdBQUc7SUFDcEIsUUFBUSxFQUFFLElBQUk7SUFDZCxRQUFRLEVBQUUsR0FBRztJQUNiLFNBQVMsRUFBRSxPQUFPO0lBQ2xCLE1BQU0sRUFBRSxHQUFHO0lBQ1gsT0FBTyxFQUFFLEdBQUc7SUFDWixPQUFPLEVBQUUsR0FBRztJQUNaLFFBQVEsRUFBRSxHQUFHO0lBQ2IsT0FBTyxFQUFFLEdBQUc7SUFDWixRQUFRLEVBQUUsR0FBRztJQUNiLE9BQU8sRUFBRSxHQUFHO0lBQ1osUUFBUSxFQUFFLEdBQUc7SUFDYixTQUFTLEVBQUUsR0FBRztJQUNkLFNBQVMsRUFBRSxHQUFHO0NBQ2pCLENBQUE7QUFFRDs7R0FFRztBQUVILElBQU0sVUFBVSxHQUFHLFVBQUMsQ0FBQztJQUNqQixJQUFJLE9BQU8sQ0FBQyxLQUFLLFFBQVE7UUFBRSxPQUFPLEVBQUUsQ0FBQTtJQUNwQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDLEtBQUss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SyxJQUFJLEVBQVYsQ0FBVSxDQUFDLENBQUM7QUFDL0IsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUUsS0FBWSxFQUFFLFVBQW1CO0lBQ3hELElBQUksVUFBVSxHQUFlLEVBQUUsQ0FBQztJQUVoQywwQkFBa0IsQ0FBQyxLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQUMsS0FBSztRQUMxRCxVQUFVLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDckQsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLFVBQVUsQ0FBQztBQUN0QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2xhc3MsIFByb3BlcnR5LCBGaWxlLCBnZXRDb21tZW50SGVhZGVyLCBnZXRJbmhlcml0YW5jZVRyZWUsIENvbnRleHQgfSBmcm9tIFwiLi4vdHlwZXNcIjtcbmltcG9ydCB7IEdlbmVyYXRlT3B0aW9ucyB9IGZyb20gXCIuLi9hcGlcIjtcblxuY29uc3QgdHlwZU1hcHMgPSB7XG4gICAgXCJzdHJpbmdcIjogXCJzdHJpbmdcIixcbiAgICBcIm51bWJlclwiOiBcInZhcmludF90XCIsXG4gICAgXCJib29sZWFuXCI6IFwiYm9vbFwiLFxuICAgIFwiaW50OFwiOiBcImludDhfdFwiLFxuICAgIFwidWludDhcIjogXCJ1aW50OF90XCIsXG4gICAgXCJpbnQxNlwiOiBcImludDE2X3RcIixcbiAgICBcInVpbnQxNlwiOiBcInVpbnQxNl90XCIsXG4gICAgXCJpbnQzMlwiOiBcImludDMyX3RcIixcbiAgICBcInVpbnQzMlwiOiBcInVpbnQzMl90XCIsXG4gICAgXCJpbnQ2NFwiOiBcImludDY0X3RcIixcbiAgICBcInVpbnQ2NFwiOiBcInVpbnQ2NF90XCIsXG4gICAgXCJmbG9hdDMyXCI6IFwiZmxvYXQzMl90XCIsXG4gICAgXCJmbG9hdDY0XCI6IFwiZmxvYXQ2NF90XCIsXG59XG5cbmNvbnN0IHR5cGVJbml0aWFsaXplciA9IHtcbiAgICBcInN0cmluZ1wiOiAnXCJcIicsXG4gICAgXCJudW1iZXJcIjogXCIwXCIsXG4gICAgXCJib29sZWFuXCI6IFwiZmFsc2VcIixcbiAgICBcImludDhcIjogXCIwXCIsXG4gICAgXCJ1aW50OFwiOiBcIjBcIixcbiAgICBcImludDE2XCI6IFwiMFwiLFxuICAgIFwidWludDE2XCI6IFwiMFwiLFxuICAgIFwiaW50MzJcIjogXCIwXCIsXG4gICAgXCJ1aW50MzJcIjogXCIwXCIsXG4gICAgXCJpbnQ2NFwiOiBcIjBcIixcbiAgICBcInVpbnQ2NFwiOiBcIjBcIixcbiAgICBcImZsb2F0MzJcIjogXCIwXCIsXG4gICAgXCJmbG9hdDY0XCI6IFwiMFwiLFxufVxuXG4vKipcbiAqIEMrKyBDb2RlIEdlbmVyYXRvclxuICovXG5cbmNvbnN0IGNhcGl0YWxpemUgPSAocykgPT4ge1xuICAgIGlmICh0eXBlb2YgcyAhPT0gJ3N0cmluZycpIHJldHVybiAnJ1xuICAgIHJldHVybiBzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcy5zbGljZSgxKTtcbn1cbmNvbnN0IGRpc3RpbmN0ID0gKHZhbHVlLCBpbmRleCwgc2VsZikgPT4gc2VsZi5pbmRleE9mKHZhbHVlKSA9PT0gaW5kZXg7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZSAoY29udGV4dDogQ29udGV4dCwgb3B0aW9uczogR2VuZXJhdGVPcHRpb25zKTogRmlsZVtdIHtcbiAgICByZXR1cm4gY29udGV4dC5jbGFzc2VzLm1hcChrbGFzcyA9PiAoe1xuICAgICAgICBuYW1lOiBrbGFzcy5uYW1lICsgXCIuaHBwXCIsXG4gICAgICAgIGNvbnRlbnQ6IGdlbmVyYXRlQ2xhc3Moa2xhc3MsIG9wdGlvbnMubmFtZXNwYWNlLCBjb250ZXh0LmNsYXNzZXMpXG4gICAgfSkpO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUNsYXNzKGtsYXNzOiBDbGFzcywgbmFtZXNwYWNlOiBzdHJpbmcsIGFsbENsYXNzZXM6IENsYXNzW10pIHtcbiAgICBjb25zdCBwcm9wZXJ0aWVzUGVyVHlwZToge1t0eXBlOiBzdHJpbmddOiBQcm9wZXJ0eVtdfSA9IHt9O1xuICAgIGNvbnN0IGFsbFJlZnM6IFByb3BlcnR5W10gPSBbXTtcbiAgICBrbGFzcy5wcm9wZXJ0aWVzLmZvckVhY2gocHJvcGVydHkgPT4ge1xuICAgICAgICBsZXQgdHlwZSA9IHByb3BlcnR5LnR5cGU7XG5cbiAgICAgICAgaWYgKCFwcm9wZXJ0aWVzUGVyVHlwZVt0eXBlXSkge1xuICAgICAgICAgICAgcHJvcGVydGllc1BlclR5cGVbdHlwZV0gPSBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHByb3BlcnRpZXNQZXJUeXBlW3R5cGVdLnB1c2gocHJvcGVydHkpO1xuXG4gICAgICAgIC8vIGtlZXAgYWxsIHJlZnMgbGlzdFxuICAgICAgICBpZiAoKHR5cGUgPT09IFwicmVmXCIgfHwgdHlwZSA9PT0gXCJhcnJheVwiIHx8IHR5cGUgPT09IFwibWFwXCIpKSB7XG4gICAgICAgICAgICBhbGxSZWZzLnB1c2gocHJvcGVydHkpO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCBhbGxQcm9wZXJ0aWVzID0gZ2V0QWxsUHJvcGVydGllcyhrbGFzcywgYWxsQ2xhc3Nlcyk7XG4gICAgY29uc3QgY3JlYXRlSW5zdGFuY2VNZXRob2QgPSAoYWxsUmVmcy5sZW5ndGggPT09IDApID8gXCJcIiA6XG4gICAgYFxcdGlubGluZSBTY2hlbWEqIGNyZWF0ZUluc3RhbmNlKHN0ZDo6dHlwZV9pbmRleCB0eXBlKSB7XG5cXHRcXHQke2dlbmVyYXRlRmllbGRJZkVsc2VDaGFpbihhbGxSZWZzLFxuICAgIChwcm9wZXJ0eSkgPT4gYHR5cGUgPT0gdHlwZWlkKCR7cHJvcGVydHkuY2hpbGRUeXBlfSlgLFxuICAgIChwcm9wZXJ0eSkgPT4gYHJldHVybiBuZXcgJHtwcm9wZXJ0eS5jaGlsZFR5cGV9KCk7YCxcbiAgICAocHJvcGVydHkpID0+IHR5cGVNYXBzW3Byb3BlcnR5LmNoaWxkVHlwZV0gPT09IHVuZGVmaW5lZCl9XG5cXHRcXHRyZXR1cm4gJHtrbGFzcy5leHRlbmRzfTo6Y3JlYXRlSW5zdGFuY2UodHlwZSk7XG5cXHR9YDtcblxuICAgIHJldHVybiBgJHtnZXRDb21tZW50SGVhZGVyKCl9XG4jaWZuZGVmIF9fU0NIRU1BX0NPREVHRU5fJHtrbGFzcy5uYW1lLnRvVXBwZXJDYXNlKCl9X0hfX1xuI2RlZmluZSBfX1NDSEVNQV9DT0RFR0VOXyR7a2xhc3MubmFtZS50b1VwcGVyQ2FzZSgpfV9IX18gMVxuXG4jaW5jbHVkZSBcInNjaGVtYS5oXCJcbiNpbmNsdWRlIDx0eXBlaW5mbz5cbiNpbmNsdWRlIDx0eXBlaW5kZXg+XG5cbiR7YWxsUmVmcy5cbiAgICBmaWx0ZXIocmVmID0+IHJlZi5jaGlsZFR5cGUgJiYgdHlwZU1hcHNbcmVmLmNoaWxkVHlwZV0gPT09IHVuZGVmaW5lZCkuXG4gICAgbWFwKHJlZiA9PiByZWYuY2hpbGRUeXBlKS5cbiAgICBjb25jYXQoZ2V0SW5oZXJpdGFuY2VUcmVlKGtsYXNzLCBhbGxDbGFzc2VzLCBmYWxzZSkubWFwKGtsYXNzID0+IGtsYXNzLm5hbWUpKS5cbiAgICBmaWx0ZXIoZGlzdGluY3QpLlxuICAgIG1hcChjaGlsZFR5cGUgPT4gYCNpbmNsdWRlIFwiJHtjaGlsZFR5cGV9LmhwcFwiYCkuXG4gICAgam9pbihcIlxcblwiKX1cblxudXNpbmcgbmFtZXNwYWNlIGNvbHlzZXVzOjpzY2hlbWE7XG5cbiR7bmFtZXNwYWNlID8gYG5hbWVzcGFjZSAke25hbWVzcGFjZX0ge2AgOiBcIlwifVxuY2xhc3MgJHtrbGFzcy5uYW1lfSA6IHB1YmxpYyAke2tsYXNzLmV4dGVuZHN9IHtcbnB1YmxpYzpcbiR7a2xhc3MucHJvcGVydGllcy5tYXAocHJvcCA9PiBnZW5lcmF0ZVByb3BlcnR5KHByb3ApKS5qb2luKFwiXFxuXCIpfVxuXG5cXHQke2tsYXNzLm5hbWV9KCkge1xuXFx0XFx0dGhpcy0+X2luZGV4ZXMgPSAke2dlbmVyYXRlQWxsSW5kZXhlcyhhbGxQcm9wZXJ0aWVzKX07XG5cXHRcXHR0aGlzLT5fdHlwZXMgPSAke2dlbmVyYXRlQWxsVHlwZXMoYWxsUHJvcGVydGllcyl9O1xuXFx0XFx0dGhpcy0+X2NoaWxkUHJpbWl0aXZlVHlwZXMgPSAke2dlbmVyYXRlQWxsQ2hpbGRQcmltaXRpdmVUeXBlcyhhbGxQcm9wZXJ0aWVzKX07XG5cXHRcXHR0aGlzLT5fY2hpbGRTY2hlbWFUeXBlcyA9ICR7Z2VuZXJhdGVBbGxDaGlsZFNjaGVtYVR5cGVzKGFsbFByb3BlcnRpZXMpfTtcblxcdH1cblxuXFx0dmlydHVhbCB+JHtrbGFzcy5uYW1lfSgpIHtcblxcdFxcdCR7Z2VuZXJhdGVEZXN0cnVjdG9ycyhhbGxQcm9wZXJ0aWVzKS5qb2luKFwiXFxuXFx0XFx0XCIpfVxuXFx0fVxuXG5wcm90ZWN0ZWQ6XG4ke09iamVjdC5rZXlzKHByb3BlcnRpZXNQZXJUeXBlKS5tYXAodHlwZSA9PlxuICAgIGdlbmVyYXRlR2V0dGVyc0FuZFNldHRlcnMoa2xhc3MsIHR5cGUsIHByb3BlcnRpZXNQZXJUeXBlW3R5cGVdKSkuXG4gICAgam9pbihcIlxcblwiKX1cblxuJHtjcmVhdGVJbnN0YW5jZU1ldGhvZH1cbn07XG4ke25hbWVzcGFjZSA/IFwifVwiIDogXCJcIn1cblxuI2VuZGlmXG5gO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZVByb3BlcnR5KHByb3A6IFByb3BlcnR5KSB7XG4gICAgbGV0IHByb3BlcnR5ID0gXCJcIjtcbiAgICBsZXQgbGFuZ1R5cGU6IHN0cmluZztcbiAgICBsZXQgaW5pdGlhbGl6ZXIgPSBcIlwiO1xuICAgIGxldCBpc1Byb3BQb2ludGVyID0gXCJcIjtcblxuICAgIGlmIChwcm9wLmNoaWxkVHlwZSkge1xuICAgICAgICBjb25zdCBpc1VwY2FzZUZpcnN0ID0gcHJvcC5jaGlsZFR5cGUubWF0Y2goL15bQS1aXS8pO1xuXG4gICAgICAgIGlmKHByb3AudHlwZSA9PT0gXCJyZWZcIikge1xuICAgICAgICAgICAgbGFuZ1R5cGUgPSBgJHtwcm9wLmNoaWxkVHlwZX1gO1xuICAgICAgICAgICAgaW5pdGlhbGl6ZXIgPSBgbmV3ICR7cHJvcC5jaGlsZFR5cGV9KClgO1xuXG4gICAgICAgIH0gZWxzZSBpZihwcm9wLnR5cGUgPT09IFwiYXJyYXlcIikge1xuICAgICAgICAgICAgbGFuZ1R5cGUgPSAoaXNVcGNhc2VGaXJzdClcbiAgICAgICAgICAgICAgICA/IGBBcnJheVNjaGVtYTwke3Byb3AuY2hpbGRUeXBlfSo+YFxuICAgICAgICAgICAgICAgIDogYEFycmF5U2NoZW1hPCR7dHlwZU1hcHNbcHJvcC5jaGlsZFR5cGVdfT5gO1xuICAgICAgICAgICAgaW5pdGlhbGl6ZXIgPSBgbmV3ICR7bGFuZ1R5cGV9KClgO1xuXG4gICAgICAgIH0gZWxzZSBpZihwcm9wLnR5cGUgPT09IFwibWFwXCIpIHtcbiAgICAgICAgICAgIGxhbmdUeXBlID0gKGlzVXBjYXNlRmlyc3QpXG4gICAgICAgICAgICAgICAgPyBgTWFwU2NoZW1hPCR7cHJvcC5jaGlsZFR5cGV9Kj5gXG4gICAgICAgICAgICAgICAgOiBgTWFwU2NoZW1hPCR7dHlwZU1hcHNbcHJvcC5jaGlsZFR5cGVdfT5gO1xuICAgICAgICAgICAgaW5pdGlhbGl6ZXIgPSBgbmV3ICR7bGFuZ1R5cGV9KClgO1xuICAgICAgICB9XG4gICAgICAgIGlzUHJvcFBvaW50ZXIgPSBcIipcIjtcblxuICAgIH0gZWxzZSB7XG4gICAgICAgIGxhbmdUeXBlID0gdHlwZU1hcHNbcHJvcC50eXBlXTtcbiAgICAgICAgaW5pdGlhbGl6ZXIgPSB0eXBlSW5pdGlhbGl6ZXJbcHJvcC50eXBlXTtcbiAgICB9XG5cbiAgICBwcm9wZXJ0eSArPSBgICR7bGFuZ1R5cGV9ICR7aXNQcm9wUG9pbnRlcn0ke3Byb3AubmFtZX1gO1xuXG4gICAgcmV0dXJuIGBcXHQke3Byb3BlcnR5fSA9ICR7aW5pdGlhbGl6ZXJ9O2Bcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVHZXR0ZXJzQW5kU2V0dGVycyhrbGFzczogQ2xhc3MsIHR5cGU6IHN0cmluZywgcHJvcGVydGllczogUHJvcGVydHlbXSkge1xuICAgIGxldCBsYW5nVHlwZSA9IHR5cGVNYXBzW3R5cGVdO1xuICAgIGxldCB0eXBlQ2FzdCA9IFwiXCI7XG5cbiAgICBjb25zdCBnZXRNZXRob2ROYW1lID0gYGdldCR7Y2FwaXRhbGl6ZSh0eXBlKX1gO1xuICAgIGNvbnN0IHNldE1ldGhvZE5hbWUgPSBgc2V0JHtjYXBpdGFsaXplKHR5cGUpfWA7XG5cbiAgICBpZiAodHlwZSA9PT0gXCJyZWZcIikge1xuICAgICAgICBsYW5nVHlwZSA9IFwiU2NoZW1hKlwiO1xuXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBcImFycmF5XCIpIHtcbiAgICAgICAgbGFuZ1R5cGUgPSBgQXJyYXlTY2hlbWE8Y2hhcio+ICpgO1xuICAgICAgICB0eXBlQ2FzdCA9IGAoQXJyYXlTY2hlbWE8Y2hhcio+ICopYDtcblxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gXCJtYXBcIikge1xuICAgICAgICBsYW5nVHlwZSA9IGBNYXBTY2hlbWE8Y2hhcio+ICpgO1xuICAgICAgICB0eXBlQ2FzdCA9IGAoTWFwU2NoZW1hPGNoYXIqPiAqKWA7XG4gICAgfVxuXG4gICAgcmV0dXJuIGBcXHRpbmxpbmUgJHtsYW5nVHlwZX0gJHtnZXRNZXRob2ROYW1lfShjb25zdCBzdHJpbmcgJmZpZWxkKVxuXFx0e1xuXFx0XFx0JHtnZW5lcmF0ZUZpZWxkSWZFbHNlQ2hhaW4ocHJvcGVydGllcyxcbiAgICAocHJvcGVydHkpID0+IGBmaWVsZCA9PSBcIiR7cHJvcGVydHkubmFtZX1cImAsXG4gICAgKHByb3BlcnR5KSA9PiBgcmV0dXJuICR7dHlwZUNhc3R9dGhpcy0+JHtwcm9wZXJ0eS5uYW1lfTtgKX1cblxcdFxcdHJldHVybiAke2tsYXNzLmV4dGVuZHN9Ojoke2dldE1ldGhvZE5hbWV9KGZpZWxkKTtcblxcdH1cblxuXFx0aW5saW5lIHZvaWQgJHtzZXRNZXRob2ROYW1lfShjb25zdCBzdHJpbmcgJmZpZWxkLCAke2xhbmdUeXBlfSB2YWx1ZSlcblxcdHtcblxcdFxcdCR7Z2VuZXJhdGVGaWVsZElmRWxzZUNoYWluKHByb3BlcnRpZXMsXG4gICAgKHByb3BlcnR5KSA9PiBgZmllbGQgPT0gXCIke3Byb3BlcnR5Lm5hbWV9XCJgLFxuICAgIChwcm9wZXJ0eSkgPT4ge1xuICAgICAgICBjb25zdCBpc1NjaGVtYVR5cGUgPSAodHlwZU1hcHNbcHJvcGVydHkuY2hpbGRUeXBlXSA9PT0gdW5kZWZpbmVkKVxuXG4gICAgICAgIGlmICh0eXBlID09PSBcInJlZlwiKSB7XG4gICAgICAgICAgICBsYW5nVHlwZSA9IGAke3Byb3BlcnR5LmNoaWxkVHlwZX0qYDtcbiAgICAgICAgICAgIHR5cGVDYXN0ID0gKGlzU2NoZW1hVHlwZSlcbiAgICAgICAgICAgICAgICA/IGAoJHtwcm9wZXJ0eS5jaGlsZFR5cGV9KilgXG4gICAgICAgICAgICAgICAgOiBgLyogYnVnPyAqL2A7XG5cbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBcImFycmF5XCIpIHtcbiAgICAgICAgICAgIHR5cGVDYXN0ID0gKGlzU2NoZW1hVHlwZSlcbiAgICAgICAgICAgICAgICA/IGAoQXJyYXlTY2hlbWE8JHtwcm9wZXJ0eS5jaGlsZFR5cGV9Kj4gKilgXG4gICAgICAgICAgICAgICAgOiBgKEFycmF5U2NoZW1hPCR7dHlwZU1hcHNbcHJvcGVydHkuY2hpbGRUeXBlXX0+ICopYDtcblxuICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09IFwibWFwXCIpIHtcbiAgICAgICAgICAgIHR5cGVDYXN0ID0gKGlzU2NoZW1hVHlwZSlcbiAgICAgICAgICAgICAgICA/IGAoTWFwU2NoZW1hPCR7cHJvcGVydHkuY2hpbGRUeXBlfSo+ICopYFxuICAgICAgICAgICAgICAgIDogYChNYXBTY2hlbWE8JHt0eXBlTWFwc1twcm9wZXJ0eS5jaGlsZFR5cGVdfT4gKilgO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGB0aGlzLT4ke3Byb3BlcnR5Lm5hbWV9ID0gJHt0eXBlQ2FzdH12YWx1ZTtcXG5cXHRcXHRcXHRyZXR1cm47YFxuICAgIH0pfVxuXFx0XFx0cmV0dXJuICR7a2xhc3MuZXh0ZW5kc306OiR7c2V0TWV0aG9kTmFtZX0oZmllbGQsIHZhbHVlKTtcblxcdH1gO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUZpZWxkSWZFbHNlQ2hhaW4oXG4gICAgcHJvcGVydGllczogUHJvcGVydHlbXSxcbiAgICBpZkNhbGxiYWNrOiAocHJvcGVydHk6IFByb3BlcnR5KSA9PiBzdHJpbmcsXG4gICAgY2FsbGJhY2s6IChwcm9wZXJ0eTogUHJvcGVydHkpID0+IHN0cmluZyxcbiAgICBmaWx0ZXI6IChwcm9wZXJ0eTogUHJvcGVydHkpID0+IGJvb2xlYW4gPSAoXykgPT4gdHJ1ZSxcbikge1xuICAgIGxldCBjaGFpbiA9IFwiXCI7XG5cbiAgICBjb25zdCB1bmlxdWVDaGVja3M6IHN0cmluZ1tdID0gW107XG4gICAgcHJvcGVydGllcy5maWx0ZXIoZmlsdGVyKS5mb3JFYWNoKChwcm9wZXJ0eSwgaSkgPT4ge1xuICAgICAgICBjb25zdCBjaGVjayA9IGlmQ2FsbGJhY2socHJvcGVydHkpO1xuICAgICAgICBpZiAodW5pcXVlQ2hlY2tzLmluZGV4T2YoY2hlY2spID09PSAtMSkge1xuICAgICAgICAgICAgdW5pcXVlQ2hlY2tzLnB1c2goY2hlY2spO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaSA9PT0gMCkgeyBjaGFpbiArPSBcImlmIFwiIH0gZWxzZSB7IGNoYWluICs9IFwiIGVsc2UgaWYgXCIgfVxuICAgICAgICBjaGFpbiArPSBgKCR7Y2hlY2t9KVxuXFx0XFx0e1xuXFx0XFx0XFx0JHtjYWxsYmFjayhwcm9wZXJ0eSl9XFxuXG5cXHRcXHR9YFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGNoYWluO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUFsbEluZGV4ZXMocHJvcGVydGllczogUHJvcGVydHlbXSkge1xuICAgIHJldHVybiBgeyR7cHJvcGVydGllcy5tYXAoKHByb3BlcnR5LCBpKSA9PiBgeyR7aX0sIFwiJHtwcm9wZXJ0eS5uYW1lfVwifWApLmpvaW4oXCIsIFwiKX19YFxuXG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlQWxsVHlwZXMocHJvcGVydGllczogUHJvcGVydHlbXSkge1xuICAgIHJldHVybiBgeyR7cHJvcGVydGllcy5tYXAoKHByb3BlcnR5LCBpKSA9PiBgeyR7aX0sIFwiJHtwcm9wZXJ0eS50eXBlfVwifWApLmpvaW4oXCIsIFwiKX19YFxufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUFsbENoaWxkU2NoZW1hVHlwZXMocHJvcGVydGllczogUHJvcGVydHlbXSkge1xuICAgIHJldHVybiBgeyR7cHJvcGVydGllcy5tYXAoKHByb3BlcnR5LCBpKSA9PiB7XG4gICAgICAgIGlmIChwcm9wZXJ0eS5jaGlsZFR5cGUgJiYgdHlwZU1hcHNbcHJvcGVydHkuY2hpbGRUeXBlXSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXR1cm4gYHske2l9LCB0eXBlaWQoJHtwcm9wZXJ0eS5jaGlsZFR5cGV9KX1gXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH0pLmZpbHRlcihyID0+IHIgIT09IG51bGwpLmpvaW4oXCIsIFwiKX19YFxufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUFsbENoaWxkUHJpbWl0aXZlVHlwZXMocHJvcGVydGllczogUHJvcGVydHlbXSkge1xuICAgIHJldHVybiBgeyR7cHJvcGVydGllcy5tYXAoKHByb3BlcnR5LCBpKSA9PiB7XG4gICAgICAgIGlmICh0eXBlTWFwc1twcm9wZXJ0eS5jaGlsZFR5cGVdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBgeyR7aX0sIFwiJHtwcm9wZXJ0eS5jaGlsZFR5cGV9XCJ9YFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9KS5maWx0ZXIociA9PiByICE9PSBudWxsKS5qb2luKFwiLCBcIil9fWBcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVEZXN0cnVjdG9ycyhwcm9wZXJ0aWVzOiBQcm9wZXJ0eVtdKSB7XG4gICAgcmV0dXJuIHByb3BlcnRpZXMubWFwKChwcm9wZXJ0eSwgaSkgPT4ge1xuICAgICAgICBpZiAocHJvcGVydHkuY2hpbGRUeXBlKSB7XG4gICAgICAgICAgICByZXR1cm4gYGRlbGV0ZSB0aGlzLT4ke3Byb3BlcnR5Lm5hbWV9O2A7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH0pLmZpbHRlcihyID0+IHIgIT09IG51bGwpO1xufVxuXG5mdW5jdGlvbiBnZXRBbGxQcm9wZXJ0aWVzIChrbGFzczogQ2xhc3MsIGFsbENsYXNzZXM6IENsYXNzW10pIHtcbiAgICBsZXQgcHJvcGVydGllczogUHJvcGVydHlbXSA9IFtdO1xuXG4gICAgZ2V0SW5oZXJpdGFuY2VUcmVlKGtsYXNzLCBhbGxDbGFzc2VzKS5yZXZlcnNlKCkuZm9yRWFjaCgoa2xhc3MpID0+IHtcbiAgICAgICAgcHJvcGVydGllcyA9IHByb3BlcnRpZXMuY29uY2F0KGtsYXNzLnByb3BlcnRpZXMpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHByb3BlcnRpZXM7XG59Il19