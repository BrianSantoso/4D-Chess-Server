<!DOCTYPE html>
<html>
	<head>
        
		<title>4D Chess</title>
		<!--	Disable Zoom on mobile	-->
		<meta name="viewport" content="width=device-width, user-scalable=no">
        
		<script src="/socket.io/socket.io.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Roboto+Mono|Source+Code+Pro|Ubuntu+Mono&display=swap" rel="stylesheet">
        <script src="js/three.js"></script>
        <script src="js/TrackballControls.js"></script>
        <script src="js/Detector.js"></script>
        <script src="js/Models.js"></script>
        <script src="js/GameBoard.js"></script>
		<script src="js/Mode.js"></script>
		<script src="js/MoveManager.js"></script>
        <script src="js/Piece.js"></script>
        <script src="js/Pointer.js"></script>
        <script src="js/Animation.js"></script>
		<script src="js/ClientStateManager.js"></script>
		<script src="js/ClientState.js"></script>
		<script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  		<script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
		<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
		<script src="https://unpkg.com/@material-ui/core@4.9.5/umd/material-ui.development.js"></script>
		
		<script src="js/lodash.js"></script>
		
		<link rel="stylesheet" type="text/css" href="css/style.css">
        
        <script type="text/babel">


			/**
			 * TODO BEFORE PRODUCTION BUILD: 
				- Replace all CDNs
				BUGS:
				- check to see if piece state is undone correctly when calling moveManager.undo()
			 */
			window.onload = function(){
                if(Detector.webgl){
					main();
                } else {
                    var warning = Detector.getWebGLErrorMessage();
                    document.getElementById('container').appendChild(warning);
                }
            };

            // declare global variables
			const SERVER = false;
			let socket;
            let scene;
            let camera;
            let renderer;
            let controls;
			let backendBoard;
			let backendMoveManager;
            let gameBoard;
			let moveManager;
            let pointer;
            let animationQueue = []
			let debugSphere;
			let stateManager = new ClientStateManager(SERVER ? ClientState.SERVER : ClientState.MENU);
			let uiProxy;
			let toolbarProxy;
			

			function main() {
				const modelLoadProm = Models.loadModels();
				modelLoadProm.then(init, function() {
					console.error("Could not load models.");
				});
			}

            function init(){
				initSocketIO();
                initTHREE();
                initControls();
				initGameBoard();
                initPointer();
				initReact();
                // begin the game loop
                requestAnimationFrame(frame);
            }

			function initSocketIO() {
				try {
					socket = io();
					socket.on('serve move', (move) => {
						console.log('received move', move)
						moveManager.move(move.x0, move.y0, move.z0, move.w0,
										move.x1, move.y1, move.z1, move.w1, true, move.metaData)
					});
					socket.on('player assignment', (playerAssignment) => {
						console.log('player assignment: ', playerAssignment)
						moveManager.loadFromPlayerAssignment(playerAssignment);
//						moveManager.clientTeam = playerAssignment.clientTeam;
//						
//						if (!moveManager.ready) {
//							moveManager.ready = playerAssignment.ready;
//						}
//						moveManager.updateUI();
//						moveManager.updateSelectability();
//						uiProxy.exitMenu();
					})
					
					socket.on('player joined', (playerAssignment) => {
						
						if (!moveManager.ready) {
							moveManager.ready = playerAssignment.ready;
						}
						moveManager.updateUI();
						moveManager.updateSelectability();
					})
					
					const gameID = window.location.pathname.substring(1);
					if (gameID.match(/g[A-Za-z0-9]{7}/)) {
						socket.emit('join', gameID);
						console.log('attempting to join: ', gameID)
					}
					
					 /*else if(gameID.match('/sandbox')) {
						uiProxy._ui.createSandboxGame();
					} else if(gameID.match('/localGame')) {
						uiProxy._ui.createLocalGame();
					}*/
					
					
				} catch(e) {
					console.error('socket.io failed to initialize')
					socket = {
						emit: function(){}
					}
				}
				
			}

			function initReact() {
				uiProxy = new EmptyUI(); // will be changed when component mounts
				toolbarProxy = new EmptyUI();
				ReactDOM.render(
				  <App />,
				  document.getElementById('gui')
				);
			}

			function initGameBoard() {
				
				gameBoard = new GameBoard(4, SERVER ? EmptyBoardGraphics : BoardGraphics);
				moveManager = new MoveManager(gameBoard, 0, Mode.ONLINE_MULTIPLAYER, true);
				
				if (SERVER) {
					return;
				}
				
				camera.position.set(600, 510, gameBoard.graphics.getCenter().z)
				const target = gameBoard.graphics.getCenter();
                controls.target.set(target.x, target.y, target.z);
				
				let coolPos = {x: 555.8170713338144, y: 506.7444028015284 + 110, z: -420}
				let coolTar = {x: 0, y: 262.5 + 110, z: -420}
				camera.position.set(coolPos.x, coolPos.y, coolPos.z);
				controls.target.set(coolTar.x, coolTar.y, coolTar.z);
				
//				debugSphere = DEBUG(controls.target, 1.0, 0);
				
//				let boundingBox = gameBoard.graphics.getBoundingBox();
//				DEBUG(boundingBox.bottomLeft);
//				DEBUG(boundingBox.topRight);
			}

            function initTHREE(){
				
				if (SERVER) {
					return;
				}

                // Code from three.js scene creation example.
                // https://threejs.org/docs/index.html#manual/introduction/Creating-a-scene
                scene = new THREE.Scene(); // Create new scene
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 9000); 
                renderer = new THREE.WebGLRenderer({antialias: true});
                renderer.setSize(window.innerWidth, window.innerHeight);
				renderer.domElement.id = "myCanvas"
                document.body.appendChild(renderer.domElement);

                renderer.setClearColor(0xf7f7f7);
                // Code from three.js ambient light example:
                // https://threejs.org/docs/index.html#api/lights/AmbientLight
                let ambientLight = new THREE.AmbientLight(0xffffff, 0.45);
                scene.add(ambientLight);
                
                let lightPosition1 = new THREE.Vector3(70, 300, -50);
                let lightPosition2 = new THREE.Vector3(-70, 300, -50);
                let directionalLightIntensity = 0.4;
                let directionalLightColour = 0xFFFFFF;
                let shadowFrustum = 50;
                let shadowMapWidth = 1024;
                let shadowMapHeight = 1024;
                let directionalLight1 = new THREE.DirectionalLight(directionalLightColour, directionalLightIntensity);
				let directionalLight2 = new THREE.DirectionalLight(directionalLightColour, directionalLightIntensity);
				directionalLight1.position.set(lightPosition1);
				
                directionalLight1.position.copy(lightPosition1);
                directionalLight1.castShadow = true;
                directionalLight1.shadow.camera.right = shadowFrustum;
                directionalLight1.shadow.camera.left = -shadowFrustum;
                directionalLight1.shadow.camera.top = shadowFrustum;
                directionalLight1.shadow.camera.bottom = -shadowFrustum;
                directionalLight1.shadow.mapSize.width = shadowMapWidth;
                directionalLight1.shadow.mapSize.height = shadowMapHeight;
                scene.add(directionalLight1);
				
				window.addEventListener( 'resize', onWindowResize, false );
				function onWindowResize(){
					camera.aspect = window.innerWidth / window.innerHeight;
					camera.updateProjectionMatrix();
					renderer.setSize( window.innerWidth, window.innerHeight );
					controls.handleResize();
				}
            }
            
            function rotateObject(object, degreeX=0, degreeY=0, degreeZ=0) {
                object.rotateX(THREE.Math.degToRad(degreeX));
                object.rotateY(THREE.Math.degToRad(degreeY));
                object.rotateZ(THREE.Math.degToRad(degreeZ));
            }
            
            // Initialize the mouse controls provided by:
            // https://threejs.org/examples/misc_controls_trackball.html
            function initControls(){

				if (SERVER) {
					return;
				}
				
                controls = new THREE.TrackballControls( camera, renderer.domElement );

                controls.rotateSpeed = 1.8; // set rotation/zoom/pan speeds
                controls.zoomSpeed = 1.5;
                controls.panSpeed = 0.45;

                controls.noZoom = false; // enable zooming, panning, and smooth panning
                controls.noPan = false;
                controls.staticMoving = false;

                controls.dynamicDampingFactor = 0.2; // set dampening factor
                controls.minDistance = 100
                controls.maxDistance = 1400
            }

            let last = 0;
            let now = window.performance.now();
            let dt;
            let accumulation = 0;
            const step = 1/60; // update simulation every 1/60 of a second (60 fps)

            function frame() {

                now = window.performance.now(); // store the time when the new frame starts
                dt = now - last; // calculate the amount of time the last frame took
                accumulation += Math.min(1, dt/1000);	// increase accumulation by the amount of time the last frame took and limit accumulation time to 1 second.

                stateManager.keyInputs(); // update mouse input

                // if the accumulated time is larger than the fixed time-step, continue to
                // update the simulation until it is caught up to real time
                while(accumulation >= step){

                    stateManager.update(); // update the simulation
                    accumulation -= step;

                }

                // render the scene
                stateManager.render(scene, camera);

                last = now;
                requestAnimationFrame(frame); // repeat the loop
            }


            // Function getRandomIntenger returns a random integer between [lowerBound, upperBound]
            function getRandomInteger(lowerBound, upperBound){
                //          [0, 1)                range                     
                return Math.floor(Math.random() * (upperBound - lowerBound) + lowerBound);
            }

			function rotateCameraAbout(camera, center, theta) {
				camera.position.sub(center);
				let x = camera.position.x,
					y = camera.position.y,
					z = camera.position.z;
				camera.position.x = x * Math.cos(theta) + z * Math.sin(theta);
    			camera.position.z = z * Math.cos(theta) - x * Math.sin(theta);
				camera.position.add(center);
			}
			
			function DEBUG(pos, color=0xff0000, opacity=0.5) {
				const geometry = new THREE.SphereGeometry( 5, 32, 32 );
				const material = new THREE.MeshBasicMaterial({color: color, transparent:true, opacity: opacity});
				const DEBUG_SPHERE = new THREE.Mesh(geometry, material);
				DEBUG_SPHERE.position.set(pos.x, pos.y, pos.z);
				scene.add(DEBUG_SPHERE);
				return DEBUG_SPHERE;
			}

			function removeEntity(objectName, scene=scene) {
				var selectedObject = scene.getObjectByName(objectName.name);
				scene.remove(selectedObject);
			}

			function eq(a, b) {
				return _.reduce(a, function(result, value, key) {
					return _.isEqual(value, b[key]) ?
						result : result.concat(key);
				}, []);
			}
			/*
			 * Compare two objects by reducing an array of keys in obj1, having the
			 * keys in obj2 as the intial value of the result. Key points:
			 *
			 * - All keys of obj2 are initially in the result.
			 *
			 * - If the loop finds a key (from obj1, remember) not in obj2, it adds
			 *   it to the result.
			 *
			 * - If the loop finds a key that are both in obj1 and obj2, it compares
			 *   the value. If it's the same value, the key is removed from the result.
			 */
			function getObjectDiff(obj1, obj2) {
				const diff = Object.keys(obj1).reduce((result, key) => {
					if (!obj2.hasOwnProperty(key)) {
						result.push(key);
					} else if (_.isEqual(obj1[key], obj2[key])) {
						const resultKeyIndex = result.indexOf(key);
						result.splice(resultKeyIndex, 1);
					}
					return result;
				}, Object.keys(obj2));

				return diff;
			}

			var compare = function (a, b) {

			  var result = {
				different: [],
				missing_from_first: [],
				missing_from_second: []
			  };

			  _.reduce(a, function (result, value, key) {
				if (b.hasOwnProperty(key)) {
				  if (_.isEqual(value, b[key])) {
					return result;
				  } else {
					if (typeof (a[key]) != typeof ({}) || typeof (b[key]) != typeof ({})) {
					  //dead end.
					  result.different.push(key);
					  return result;
					} else {
					  var deeper = compare(a[key], b[key]);
					  result.different = result.different.concat(_.map(deeper.different, (sub_path) => {
						return key + "." + sub_path;
					  }));

					  result.missing_from_second = result.missing_from_second.concat(_.map(deeper.missing_from_second, (sub_path) => {
						return key + "." + sub_path;
					  }));

					  result.missing_from_first = result.missing_from_first.concat(_.map(deeper.missing_from_first, (sub_path) => {
						return key + "." + sub_path;
					  }));
					  return result;
					}
				  }
				} else {
				  result.missing_from_second.push(key);
				  return result;
				}
			  }, result);

			  _.reduce(b, function (result, value, key) {
				if (a.hasOwnProperty(key)) {
				  return result;
				} else {
				  result.missing_from_first.push(key);
				  return result;
				}
			  }, result);

			  return result;
			}

			function genGameId() {
				return 'gxxxxxxx'.replace(/[x]/g, function(character) {
					const r = Math.random() * 16 | 0
					const v = character == 'x' ? r : (r & 0x3 | 0x8);
					return v.toString(16);
				});
			}
			
        </script>
		
        
	</head>
    <body>
		<div id="gui" class="overlay"></div>
		<script type="text/babel">

			function EmptyUI() {
				this.setState = function(state) {
					console.warn('proxy setState called before react component mounted')
				}
				this.exitMenu = function() {
					console.warn('proxy exitMenu called before react component mounted')
				}
				
			}

			function UI(reactComponent) {
				this._ui = reactComponent;
				this.setState = function(state) {
//					console.log(state)
					this._ui.setState(state);
				}
				
				
				this.exitMenu = function() {
					this._ui.exitMenu();
				}
			}

			class App extends React.Component {
				
				constructor(props) {
					super(props);
					this.state = {clientState: stateManager.state};
					this.swapState = this.swapState.bind(this)
					this.exitMenu = this.exitMenu.bind(this)
					this.backToMenu = this.backToMenu.bind(this)
					
					this.playButtonClick = this.playButtonClick.bind(this)
					this.matchmake = this.matchmake.bind(this)
					this.createSandboxGame = this.createSandboxGame.bind(this)
					this.createLocalGame = this.createLocalGame.bind(this)
				}
				
				swapState(clientState) {
					console.log("App.swapState called")
					this.setState({
						clientState: clientState
					})
					stateManager.swapState(clientState);
				}
				
				exitMenu() {
					let whichSide = -2 * moveManager.clientTeam + 1;
					if (moveManager.clientTeam === -1) {
						whichSide = 1;
					}
					const cameraDestination = new THREE.Vector3(600 * whichSide, 510, gameBoard.graphics.getCenter().z);
					const smoothness = 3/300;
					const squaredEpsilon = 100;
					const interpolatedCoords = CameraAnimation.smoothLerp(camera.position, cameraDestination, smoothness, squaredEpsilon);
					CameraAnimation.addToQueue(animationQueue, camera, interpolatedCoords)
					this.swapState(ClientState.GAME_STATE);
				}
				
				matchmake() {
					socket.emit('matchmake');
					// TODO: Show matchmaking screen
					uiProxy.exitMenu();
				}
				
				createPrivateGame() {
					const gameID = genGameId()
					socket.emit('join', gameID);
					history.pushState({}, null, gameID);
//					uiProxy.exitMenu();
				}
				
				createSandboxGame() {
					history.pushState({}, null, 'sandbox');
					moveManager.setMode(Mode.SANDBOX);
					moveManager.updateUI();
					moveManager.updateSelectability();
					this.exitMenu();
				}
				
				createLocalGame() {
					history.pushState({}, null, 'localGame');
					moveManager.setMode(Mode.LOCAL_MULTIPLAYER);
					moveManager.updateUI();
					moveManager.updateSelectability();
					this.exitMenu();
				}
				
				componentDidMount() {
					uiProxy = new UI(this);
				}
				
				render() {
					if (this.state.clientState === ClientState.MENU) {
						return this.menu();
					} else if(this.state.clientState === ClientState.PLAY_OPTIONS) {
						return this.playOptions();
					} else {
						return this.game();
					}
				}
				
				menu() {
					console.log('MENU')
					return (
						<div className="overlay">
							<h1 className="text" id="gameTitle">4D Chess </h1>
							<h1 className="text" id="gameSubTitle"> Online </h1>
							<PlayButton id="playButton" text="Play" handleClick={this.playButtonClick}/>
							<PlayButton id="privateRoomButton" text="Create Private Game" handleClick={this.createPrivateGame}/>
						</div>
					);
				}
				
				playButtonClick() {
					this.swapState(ClientState.PLAY_OPTIONS);
				}
				
				backToMenu() {
					this.swapState(ClientState.MENU);
				}
				
				playOptions() {
					console.log('PLAY OPTIONS')
					return (
						<div className="overlay">
							<div id="playOptionsMenu">
								<h1 className="text"> Pick a Game Mode</h1>
								<PlayOption id="matchmakingButton" text="Online Matchmaking" handleClick={this.matchmake}></PlayOption>
								<PlayOption id="localMultiplayerButton" text="Local Multiplayer" handleClick={this.createLocalGame}></PlayOption>
								<PlayOption id="sandboxButton" text="Free Play" handleClick={this.createSandboxGame}></PlayOption>
								<PlayOption id="backToMenuButton" text="Back To Menu" handleClick={this.backToMenu}></PlayOption>
							</div>
						</div>
					);
				}
				
				game() {
					console.log('GAME')
//					return (
//						<div className="overlay">
//							<div id="toolbar">
//								<UndoButton/>
//								<MoveStatus ref={(ourComponent) => {toolbarProxy = new UI(ourComponent)}}></MoveStatus>
//								<RedoButton/>
//							</div>
//						</div>
//					);
					return (
						<div className="overlay">
							<div id="toolbar">
								<UndoButton/>
								<MoveStatus ref={(ourComponent) => {
//										toolbarProxy = new UI(ourComponent)
									}}></MoveStatus>
								<RedoButton/>
							</div>
						</div>
					);
				}
			}

			class MoveStatus extends React.Component {
				constructor(props) {
					super(props)
					this.state = {
						text: ""
					}
					
					moveManager.updateUI();
					
				}
				
				componentDidMount() {
					toolbarProxy = new UI(this);
					moveManager.updateUI();
			  	}
				
				render() {
					return (
						<div id="moveStatus" className="text toolbarItem">
							{this.state.text}
						</div>
					)
				}
				
			}

			class RectMenuButton extends React.Component {
				constructor(props) {
					super(props)
					this.handleClick = this.props.handleClick;
					this.text = this.props.text;
					this.id = this.props.id;
				}
				
				render() {
					return (<button onClick={this.handleClick} className="text rectButton" id={this.id}>
								{this.text}
							</button>);
				}
			}

			

			class PlayButton extends RectMenuButton {
				constructor(props) {
					super(props)
					
				}
				
			}

			class PlayOption extends RectMenuButton {
				constructor(props) {
					super(props)
					
				}
				render() {
					return (<button onClick={this.handleClick} className="text rectButton playOptionButton" id={this.id}>
								{this.text}
							</button>)
				}
			}

			class MoveHistoryButton extends React.Component {
				construcor(props) {
					this.state = {};
				}

				render() {
					return (
						<a onClick={this.handleClick} className="moveHistoryButton toolbarItem" id={this.id}>
							<img src={this.imgSrc}/>
						</a>
					);
				}
			}

			class RedoButton extends MoveHistoryButton {
				constructor(props) {
					super(props);
					this.imgSrc = "./icons/arrow_forward_ios-24px.svg"
					this.id = "redoButton";
					
					this.handleClick = this.handleClick.bind(this);
				}

				handleClick() {
					moveManager.redo();
				}
			}

			class UndoButton extends MoveHistoryButton {
				constructor(props) {
					super(props);
					this.id = "undoButton";
					this.imgSrc = "./icons/arrow_back_ios-24px.svg";
					
					this.handleClick = this.handleClick.bind(this);
				}

				handleClick() {
					moveManager.undo();
				}
			}

		</script>
	</body>
    
</html>      